{% extends "includes/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-car me-2"></i>Симулятор эксплуатации ТС</h2>

    <form method="post" action="{% url 'vehicle_simulation:simulate' %}" class="needs-validation" novalidate id="simulation-form">
        {% csrf_token %}

        <!-- Блок выбора типа анализа -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="my-0 fw-normal"><i class="fas fa-chart-pie me-2"></i>Тип анализа</h4>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group" aria-label="Тип анализа">
                    <!-- Радиокнопка для анализа одного ТС -->
                    <input type="radio" class="btn-check" name="analysis_type" id="analysis_type_single"
                           value="single" autocomplete="off"
                           {% if form.analysis_type.value == 'single' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="analysis_type_single">
                        <i class="fas fa-car me-1"></i> Одно ТС
                    </label>

                    <!-- Радиокнопка для сравнения типов -->
                    <input type="radio" class="btn-check" name="analysis_type" id="analysis_type_avg"
                           value="type_avg" autocomplete="off"
                           {% if form.analysis_type.value == 'type_avg' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="analysis_type_avg">
                        <i class="fas fa-clone me-1"></i> Сравнение типов
                    </label>
                </div>
            </div>
        </div>

        <!-- Блок выбора конкретного ТС (виден только при выборе "Одно ТС") -->
        <div id="single-analysis" class="card mb-4 shadow-sm card-hoverable"
             style="display: {% if form.analysis_type.value == 'single' %}block{% else %}none{% endif %};">
            <div class="card-header bg-info text-white">
                <h4 class="my-0 fw-normal"><i class="fas fa-car me-2"></i>Выбор транспортного средства</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Блок выбора ДВС -->
                    <div class="col-md-3">
                        <div class="card h-100 border-primary">
                            <div class="card-header bg-primary bg-opacity-10 border-primary">
                                <h5 class="mb-0"><i class="fas fa-gas-pump me-2"></i>ДВС</h5>
                            </div>
                            <div class="card-body">
                                {{ form.ice_vehicle }}
                                {% if form.ice_vehicle.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.ice_vehicle.errors|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Блок выбора гибрида -->
                    <div class="col-md-3">
                        <div class="card h-100 border-success">
                            <div class="card-header bg-success bg-opacity-10 border-success">
                                <h5 class="mb-0"><i class="fas fa-car-battery me-2"></i>Гибрид</h5>
                            </div>
                            <div class="card-body">
                                {{ form.hevv_vehicle }}
                                {% if form.hevv_vehicle.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.hevv_vehicle.errors|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Блок выбора PHEV -->
                    <div class="col-md-3">
                        <div class="card h-100 border-success">
                            <div class="card-header bg-success bg-opacity-10 border-success">
                                <h5 class="mb-0"><i class="fas fa-charging-station me-2"></i>PHEV</h5>
                            </div>
                            <div class="card-body">
                                {{ form.phevv_vehicle }}
                                {% if form.phevv_vehicle.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.phevv_vehicle.errors|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Блок выбора электромобиля -->
                    <div class="col-md-3">
                        <div class="card h-100 border-warning">
                            <div class="card-header bg-warning bg-opacity-10 border-warning">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Электро</h5>
                            </div>
                            <div class="card-body">
                                {{ form.ev_vehicle }}
                                {% if form.ev_vehicle.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.ev_vehicle.errors|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Блок выбора типов для сравнения (виден только при выборе "Сравнение типов") -->
        <div id="type-comparison" class="card mb-4 shadow-sm card-hoverable"
             style="display: {% if form.analysis_type.value == 'type_avg' %}block{% else %}none{% endif %};">
            <div class="card-header bg-info text-white">
                <h4 class="my-0 fw-normal"><i class="fas fa-filter me-2"></i>Какие типы сравнивать</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Чекбокс для ДВС -->
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compare_ice" name="compare_types"
                                   value="ICE" {% if 'ICE' in form.compare_types.value or not form.is_bound %}checked{% endif %}>
                            <label class="form-check-label" for="compare_ice">
                                <i class="fas fa-gas-pump me-1"></i> ДВС
                            </label>
                        </div>
                    </div>

                    <!-- Чекбокс для гибридов -->
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compare_hev" name="compare_types"
                                   value="HEV" {% if 'HEV' in form.compare_types.value or not form.is_bound %}checked{% endif %}>
                            <label class="form-check-label" for="compare_hev">
                                <i class="fas fa-car-battery me-1"></i> Гибриды
                            </label>
                        </div>
                    </div>

                    <!-- Чекбокс для PHEV -->
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compare_phev" name="compare_types"
                                   value="PHEV" {% if 'PHEV' in form.compare_types.value or not form.is_bound %}checked{% endif %}>
                            <label class="form-check-label" for="compare_phev">
                                <i class="fas fa-charging-station me-1"></i> PHEV
                            </label>
                        </div>
                    </div>

                    <!-- Чекбокс для электромобилей -->
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compare_ev" name="compare_types"
                                   value="EV" {% if 'EV' in form.compare_types.value or not form.is_bound %}checked{% endif %}>
                            <label class="form-check-label" for="compare_ev">
                                <i class="fas fa-bolt me-1"></i> Электро
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Блок параметров симуляции -->
        <div class="card mb-4 shadow-sm card-hoverable">
            <div class="card-header bg-success text-white">
                <h4 class="my-0 fw-normal"><i class="fas fa-sliders-h me-2"></i>Параметры симуляции</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Поле для даты начала -->
                    <div class="col-md-6">
                        <label for="{{ form.start_date.id_for_label }}" class="form-label">Дата начала</label>
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.start_date.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Поле для даты окончания -->
                    <div class="col-md-6">
                        <label for="{{ form.end_date.id_for_label }}" class="form-label">Дата окончания</label>
                        {{ form.end_date }}
                        {% if form.end_date.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.end_date.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Поле для часов в день -->
                    <div class="col-md-6">
                        <label for="{{ form.daily_hours.id_for_label }}" class="form-label">Часов в день</label>
                        <div class="input-group">
                            {{ form.daily_hours }}
                            <span class="input-group-text">ч/день</span>
                        </div>
                        {% if form.daily_hours.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.daily_hours.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Поле для источника энергии -->
                    <div class="col-md-6">
                        <label for="{{ form.energy_source.id_for_label }}" class="form-label">Источник энергии</label>
                        {{ form.energy_source }}
                        {% if form.energy_source.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.energy_source.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопка отправки формы -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-lg btn-warning btn-calculate">
                <i class="fas fa-play me-2"></i> Запустить симуляцию
            </button>
        </div>
    </form>
</div>

<!-- JavaScript для обработки формы -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Элементы для переключения
    const analysisTypeRadios = document.querySelectorAll('input[name="analysis_type"]');
    const singleAnalysisDiv = document.getElementById('single-analysis');
    const typeComparisonDiv = document.getElementById('type-comparison');

    // Функция переключения видимости блоков
    function toggleAnalysisBlocks() {
        const selectedValue = document.querySelector('input[name="analysis_type"]:checked').value;
        singleAnalysisDiv.style.display = selectedValue === 'single' ? 'block' : 'none';
        typeComparisonDiv.style.display = selectedValue === 'type_avg' ? 'block' : 'none';
    }

    // Назначение обработчиков на радиокнопки
    analysisTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleAnalysisBlocks);
    });

    // Инициализация при загрузке
    toggleAnalysisBlocks();

    // Отладочный вывод при отправке формы
    const form = document.getElementById('simulation-form');
    form.addEventListener('submit', function() {
        console.log('Отправка формы, выбранные типы:',
            Array.from(document.querySelectorAll('input[name="compare_types"]:checked'))
            .map(el => el.value));
    });
});
</script>

{% endblock %}